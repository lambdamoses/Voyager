---
title: "Basic quality control on scRNA-seq data with ClickTag barcodes"
author: "Kayla Jackson and A. Sina Booeshaghi"
date: "`r Sys.Date()`"
output: 
  html_document:
  toc: true
  toc_float:
    collapsed: false
  toc_depth: 3
jupyter:
  kernelspec:
    display_name: R
    language: R
    name: ir
bibliography: ref.bib
vignette: >
  %\VignetteIndexEntry{clicktag_qc}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>", fig.align = "center"
)
```

```{r, include = FALSE, eval = FALSE}
# Install Google Colab dependencies
# Note: this can take 30+ minutes (many of the dependencies include C++ code, which needs to be compiled)

# First install `sf`, `ragg` and `textshaping` and their system dependencies:
system("apt-get -y update && apt-get install -y  libudunits2-dev libgdal-dev libgeos-dev libproj-dev libharfbuzz-dev libfribidi-dev")
install.packages("sf")
install.packages("textshaping")
install.packages("ragg")

# Install system dependencies of some other R packages that Voyager either imports or suggests:
system("apt-get install -y libfribidi-dev libcairo2-dev libmagick++-dev")

# Install Voyager from Bioconductor:
install.packages("BiocManager")
BiocManager::install(version = "release", ask = FALSE, update = FALSE, Ncpus = 2)
BiocManager::install("scater")
system.time(
  BiocManager::install("Voyager", dependencies = TRUE, Ncpus = 2, update = FALSE)
)


packageVersion("Voyager")
```

# Introduction
The data in this vignette is shipped with the `cellatlas` repository. The count matrix and metadata are provided in the `cellatlas/examples` folder as an [`AnnData`](https://anndata-tutorials.readthedocs.io/en/latest/getting-started.html) object. We will begin by loading the object and converting it to a `SingleCellExperiment` object. 

```{r, message=FALSE}
library(stringr)
library(DropletUtils)
library(Matrix)
library(SpatialExperiment)
library(SpatialFeatureExperiment)
library(scater)
library(scuttle)
library(Voyager)
library(ggplot2)
theme_set(theme_bw())
```

```{r, results='hide', message=TRUE}
if (!file.exists("clicktags.rds"))
    download.file("https://github.com/pachterlab/voyager/raw/documentation-devel/vignettes/clicktags.rds", destfile = "clicktags.rds")
sce <- readRDS("clicktags.rds")
```

```{r}
sce <- addPerCellQCMetrics(sce)
names(colData(sce))
```

```{r}
plotColData(sce, "sum") +
    plotColData(sce, "detected") 
```

```{r}
plotColData(sce, x = "sum", y = "detected", bins = 100) +
    scale_fill_distiller(palette = "Blues", direction = 1)
```
```{r knee-plot}
bcrank <- barcodeRanks(counts(sce))

knee <- metadata(bcrank)$knee
inflection <- metadata(bcrank)$inflection

plot(bcrank$rank, bcrank$total, log="xy",
      xlab="Rank", ylab="Total ClickTags count", cex.lab=1.2)

abline(h=inflection, col="darkgreen", lty=2)
abline(h=knee, col="dodgerblue", lty=2)
```

```{r subset-qc}
sce <- sce[, colSums(counts(sce)) > inflection]

sce
```

```{r}
sessionInfo()
```

